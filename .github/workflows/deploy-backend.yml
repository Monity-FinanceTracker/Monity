name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
      - master
      - production
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch: # Allows manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint || echo "No lint script found, skipping..."

      - name: Run tests
        run: npm test || echo "No tests configured yet"

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: true

  deploy:
    name: Deploy to EC2
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Required Secrets
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "âŒ ERROR: EC2_HOST secret is not set!"
            echo "Please add EC2_HOST secret in: Settings â†’ Secrets â†’ Actions"
            echo "Value should be your EC2 IP address or domain (e.g., 3.14.159.265)"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_USERNAME }}" ]; then
            echo "âŒ ERROR: EC2_USERNAME secret is not set!"
            echo "Please add EC2_USERNAME secret (usually 'ec2-user' or 'ubuntu')"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "âŒ ERROR: EC2_SSH_KEY secret is not set!"
            echo "Please add EC2_SSH_KEY secret with your private SSH key"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Configure SSH
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$EC2_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "Scanning SSH keys for host: $EC2_HOST"
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
            set -e

            echo "ðŸ“¦ Navigating to application directory..."
            cd ~/Monity/backend || cd /home/ec2-user/Monity/backend || cd /var/www/Monity/backend

            echo "ðŸ”„ Pulling latest changes..."
            git fetch origin
            git checkout main
            git pull origin main

            echo "ðŸ“š Installing dependencies..."
            npm ci --production

            echo "ðŸ”„ Reloading PM2 process..."
            pm2 reload monity-backend --update-env || pm2 restart monity-backend

            echo "âœ… Deployment completed!"
            pm2 status
          ENDSSH

      - name: Update Environment Variables (if changed)
        if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[update-env]')
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          BACKEND_ENV_FILE: ${{ secrets.BACKEND_ENV_FILE }}
        run: |
          ssh -i ~/.ssh/deploy_key $EC2_USERNAME@$EC2_HOST << 'ENDSSH'
            cd ~/Monity/backend || cd /home/ec2-user/Monity/backend || cd /var/www/Monity/backend

            echo "Updating .env file..."
            cat > .env << 'EOF'
          ${{ secrets.BACKEND_ENV_FILE }}
          EOF

            echo "Restarting application with new environment..."
            pm2 restart monity-backend
          ENDSSH

      - name: Health Check
        run: |
          echo "â³ Waiting 10 seconds for application to start..."
          sleep 10

          echo "ðŸ¥ Running health check..."
          HEALTH_URL="${{ secrets.BACKEND_API_URL || 'https://api.monity-finance.com' }}/api/v1/health"

          for i in {1..5}; do
            if curl -f -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" | grep -q "200"; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 5 seconds..."
            sleep 5
          done

          echo "âŒ Health check failed after 5 attempts"
          exit 1

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Backend deployment completed successfully!"
          echo "ðŸš€ Application: monity-backend"
          echo "ðŸŒ Host: ${{ secrets.EC2_HOST }}"
          echo "ðŸ“Š Check PM2: ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} 'pm2 status'"

      - name: Rollback on Failure
        if: failure()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          echo "âŒ Deployment failed, attempting rollback..."
          ssh -i ~/.ssh/deploy_key $EC2_USERNAME@$EC2_HOST << 'ENDSSH' || true
            cd ~/Monity/backend || cd /home/ec2-user/Monity/backend || cd /var/www/Monity/backend

            echo "Rolling back to previous commit..."
            git reset --hard HEAD~1

            echo "Restarting application..."
            pm2 restart monity-backend

            echo "Rollback completed"
          ENDSSH
